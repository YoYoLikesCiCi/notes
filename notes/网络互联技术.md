网络互联技术

# 1.简述VLAN标签工作过程。

- 当数据帧需要从中继链路上转发出去时，执行以下操作：
    1. 如果数据帧所属VLAN是本征VLAN，数据帧不打VLAN标签，直接从中继链路发送出去；
    2. 如果数据帧所属VLAN不是本征VLAN，打上对应的VLAN标签，并从中继链路发送出去。

- 中继链路另一端（即接收端）收到一个数据帧，执行以下操作：

1. 如果收到的数据帧没有VLAN标签，则该数据帧所属VLAN为本征VLAN，从所有属于本征VLAN所在VLAN的接入端口和中继端口转发出去；

2. 如果收到的数据帧是带有VLAN标签的802.1Q帧，根据VLAN标签判断数据帧所属的VLAN，然后去掉数据帧中的VLAN标签，并从所有属于该VLAN的接入端口和中继端口转发。

![image-20200415175948395](http://picbed.yoyolikescici.cn/uPic/image-20200415175948395.png)





# 2.简述STP、RSTP和MSTP主要特点和工作原理。

### 1. 特点

1. STP不能使端口状态快速迁移，即使是在点对点链路或边缘端口，也必须等待2 倍的Forward delay 的时间延迟，端口才能迁移到转发状态。

2. RSTP可以快速收敛，但是和STP 一样存在以下缺陷：局域网内所有网桥共享一棵生成树，不能按VLAN 阻塞冗余链路，所有VLAN 的报文都沿着一棵生成树进行转发。

3. MSTP将环路网络修剪成为一个无环的树型网络，避免报文在环路网络中的增生和无限循环，同时还提供了数据转发的多个冗余路径，在数据转发过程中实现VLAN 数据的负载均衡。

4. MSTP兼容STP 和RSTP，并且可以弥补STP 和RSTP的缺陷。它既可以快速收敛，也能使不同VLAN的流量沿各自的路径分发，从而为冗余链路提供了更好的负载分担机制

### 2. 工作原理

1. STP
    1. 在每个运行STP协议的设备上依据一定的准则选举出一个树根节点作为网络中的根桥，其他节点为非树根节点。
    2. 每一个非树根节点，会选择最优的路径和根桥相连，每个非树根节点上位于最优路径的端口，为该非树根节点的根端口。
    3. 如果非树根节点存在冗余链路，则会对相应端口进行阻塞。
2. RSTP
    1. RSTP的出现解决了延时的问题，它的收敛速度很快，当然CISCO也针对这种技术推出了自已的RPVST+技术。RSTP在STP基础上额外定义了两种port role（注意这里的概念，端口角色），分别是alternate与backup。另外重新规定了port state（端口状态），分别为discarding、Learning、Forwarding.
    2. RSTP最重要的变化在于对BPDU中type字段的利用上，之前STP只使用了其中的两个位，另外6个位中实现了很多的功能，包括不再需要去等待50秒的时间完成主备切换，直接利用proposal与agreement协商即可，这样大大缩短了收敛时间。
    3. RSTP还定义了两个新的概念：edge port与link type，如果是edge port，表明下面接的只能是主机，环路的存在是不可能的，所以我们可以直接将其从discarding切换到forwarding状态，类似于STP中的port fast技术。而link type定义了这条链路是point-to-point的还是shared。如果有pt-pt环境下，我们就可以做快速的切换了。

3. MSTP
    1. MSTP可以将多个VLAN的生成树映射为一个实例，即vlan map to a instance，我们不需要那么多的生成树，只需要按照冗余链路的条数来得出需要几棵生成树。
    2. MSTP是基于RSTP的，没有RSTP，MSTP是无法运行的。



# 3.详细叙述STP的选举根桥、非根网桥/交换机选择根端口、为每个网段选择指定端口三个任务的工作过程。

1. 选举根桥
    -  每一个交换机启动stp服务，都会认为自己是跟桥，并向外发送以自己为根桥的配置BPDU报文。
    - 交换机接收到BPDU报文，会和自己的桥ID对比，桥ID由优先级和mac地址组成，先比较优先级，优先级相同，再比较mac地址，值越小就会认为更优。比如接收到BPDU报文的root id为8192-0000.0000.0001，自己的桥id为32768-0000.0000.0002，因为先比较优先级，优先级8192优于32768，则认为自己不是根桥，就不发送认为自己是根桥的BPDU了，并通过接收到的BPDU报文更新自身的配置BPDU。直到网络中所有的交换机都达成一致，认为某一个交换机为根桥，根桥的选举结束，从而确认唯一根桥。
2. 非根网桥/交换机选择根端口
    - 当一个交换机多个接口同时接收到了根桥发来的配置BPDU报文，会获取Root Path Cost，也就是根路径开销，与接收端口的链路开销相加，得到此端口到根桥的根路径开销，对比，根路径开销值最小的作为根端口。
    - 如果根路径开销相同，对比BPDU报文中的Bridge Identifier，也就是发送该BPDU报文指定桥的ID，ID小的作为根端口。
    - 如果指定桥ID也相同，则对比Port Identifier，发送口的端口ID，ID小的作为根端口
3. 为每个网段选择指定端口
    - 当确定根端口后，会将通过自己从根端口收到的BPDU报文计算生成的配置BPDU报文与非根端口接收到的配置BPDU进行比较，依次对比根路径开销、指定桥和端口id，自己计算产生的BPDU优于接收到的，则将此接收到的端口设置为指定端口，否则设置为Alternate端口（即阻塞起来）。







# 4.简述网关冗余协议的工作原理。

###1.  VRRP

- VRRP协议是由IETF（Internet Engineering Task Force，因特网工程任务组）推出的网关冗余协议
- VRRP将一组路由器组成一个虚拟的路由器，即一个VRRP备份组。
- 在一个VRRP组中选出一台主用（Master）路由器和若干台备用（Backup）路由器
- 正常情况下到虚拟路由器IP地址的转发请求由主用路由器负责提供转发服务功能；
- 当主用路由器出现故障时，备用路由器接替主用路由器的工作承担流量的转发。
- 工作过程：
    - 当路由器开启VRRP功能后，会根据优先级确定自己在备份组中是主用路由器还是备份路由器。其规则如下：
        1. 优先级最高的路由器为主用路由器。IP地址拥有者的VRRP优先级为255，直接被选择为主用路由器，VRRP备份组中其它路由器则成为备用路由器。
        2. 如果VRRP备份组中所有路由器的优先级相同，则比较启用VRRP接口的IP地址，IP地址最大的被选择为主用路由器。

### 2. HSRP

- HSRP是Cisco公司于1994年开发的私有协议
- 在一个HSRP热备组中，有一台活跃（Active）路由器来负责处理发送到虚拟IP地址的所有请求，一台备用（Standby）路由器，可能还会有多台监听路由器。



# 5.简述NAT的工作过程。

### 1. 地址转换

- NAT的基本工作原理是，当私有网主机和公共网主机通信的IP包经过NAT网关时，将IP包中的源IP或目的IP在私有IP和NAT的公共IP之间进行转换。

- 如下图所示，NAT网关有2个网络端口，其中公共网络端口的IP地址是统一分配的公共 IP，为202.20.65.5；私有网络端口的IP地址是保留地址，为192.168.1.1。私有网中的主机192.168.1.2向公共网中的主机202.20.65.4发送了1个IP包(Dst=202.20.65.4,Src=192.168.1.2)。

    ![img](http://picbed.yoyolikescici.cn/uPic/20150414102310625.png)

- 当IP包经过NAT网关时，NAT Gateway会将IP包的源IP转换为NAT Gateway的公共IP并转发到公共网，此时IP包（Dst=202.20.65.4，Src=202.20.65.5）中已经不含任何私有网IP的信息。由于IP包的源IP已经被转换成NAT Gateway的公共IP，Web Server发出的响应IP包（Dst= 202.20.65.5,Src=202.20.65.4）将被发送到NAT Gateway。
- 这时，NAT Gateway会将IP包的目的IP转换成私有网中主机的IP，然后将IP包（Des=192.168.1.2，Src=202.20.65.4）转发到私有网。对于通信双方而言，这种地址的转换过程是完全透明的。转换示意图如下。
- ![img](http://picbed.yoyolikescici.cn/uPic/20150414102327723.png)

- 如果内网主机发出的请求包未经过NAT，那么当Web Server收到请求包，回复的响应包中的目的地址就是私网IP地址，在Internet上无法正确送达，导致连接失败。

### 2. 连接跟踪

- 在上述过程中，NAT Gateway在收到响应包后，就需要判断将数据包转发给谁。此时如果子网内仅有少量客户机，可以用静态NAT手工指定；但如果内网有多台客户机，并且各自访问不同网站，这时候就需要连接跟踪（connection track）。如下图所示：
- ![img](http://picbed.yoyolikescici.cn/uPic/20150414102338487.png)
- 在NAT Gateway收到客户机发来的请求包后，做源地址转换，并且将该连接记录保存下来，当NAT Gateway收到服务器来的响应包后，查找Track Table，确定转发目标，做目的地址转换，转发给客户机。

### 3. 端口转换

- 以上述客户机访问服务器为例，当仅有一台客户机访问服务器时，NAT Gateway只须更改数据包的源IP或目的IP即可正常通讯。但是如果Client A和Client B同时访问Web Server，那么当NAT Gateway收到响应包的时候，就无法判断将数据包转发给哪台客户机，如下图所示。
- ![img](http://picbed.yoyolikescici.cn/uPic/20150414102435517.png)
- 此时，NAT Gateway会在Connection Track中加入端口信息加以区分。如果两客户机访问同一服务器的源端口不同，那么在Track Table里加入端口信息即可区分，如果源端口正好相同，那么在时行SNAT和DNAT的同时对源端口也要做相应的转换，如下图所示。（这里的理解灰常重要）
- ![img](https://img-blog.csdn.net/20150414102442194)